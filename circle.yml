machine:
  node:
    version: 6.1.0
  services:
    - docker
  pre:
    - sudo apt-get update -qq && sudo apt-get install -y -qq sqlite3 libsqlite3-dev
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    - curl -L https://github.com/docker/compose/releases/download/1.6.0/docker-compose-`uname -s`-`uname -m` > /home/ubuntu/bin/docker-compose
    - chmod +x /home/ubuntu/bin/docker-compose
    - docker-compose version

dependencies:
  override:
    - docker info
    - docker build -f Dockerfile-prod -t levibostian/foo:latest .
    - docker tag levibostian/foo:latest 1234567890.dkr.ecr.us-east-1.amazonaws.com/levibostian/foo:latest

test:
  override:
    - npm install
    - npm run test
    - docker run -d --name=foo -e "VIRTUAL_HOST=foo.levibostian.com" -e "API_MAILGUN_API_KEY=fake" --net=host -p 5000:5000 levibostian/foo:latest; sleep 10
    - curl --retry 10 --retry-delay 5 -v localhost:5000/

deployment:
  hub:
    branch: master
    commands:
      - eval $(aws ecr get-login --region us-east-1)
      - docker push 1234567890.dkr.ecr.us-east-1.amazonaws.com/levibostian/foo:latest
      - ./deploy.sh
